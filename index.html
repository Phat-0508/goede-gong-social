<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VÄƒn HÃ³a Cá»“ng ChiÃªng NgÆ°á»i ÃŠ ÄÃª</title>

  <!-- Font kiá»ƒu máº¡ng xÃ£ há»™i -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="responsive.css" />
</head>

<body>
  <!-- App Shell -->
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge">ğŸ¥</div>
        <div class="brand-text">
          <div class="brand-title">EÌ‚ ÄÃª Gong</div>
          <div class="brand-sub">Social Museum</div>
        </div>
      </div>

      <nav class="side-nav">
        <!-- Giá»¯ nguyÃªn liÃªn káº¿t -->
        <a class="nav-link" href="#home">ğŸ  Trang chá»§</a>
        <a class="nav-link" href="#about">ğŸ“š Giá»›i thiá»‡u</a>
        <a class="nav-link" href="#collection">ğŸ—‚ï¸ Bá»™ sÆ°u táº­p</a>
        <a class="nav-link" href="#add">â• ThÃªm má»›i</a>
        <a class="nav-link" href="#stats">ğŸ“ˆ Thá»‘ng kÃª</a>
      </nav>

      <div class="sidebar-footer">
        <div class="server-chip">
          <span class="dot" id="serverDot"></span>
          <span>Server:</span>
          <span id="serverStatus">Äang kiá»ƒm tra...</span>
        </div>
        <div class="hint">Tip: má»Ÿ báº±ng Live Server Ä‘á»ƒ trÃ¡nh lá»—i fetch.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <header class="topbar">
        <div class="topbar-left">
          <button class="icon-btn" id="menuBtn" aria-label="Menu">â˜°</button>
          <div class="page-title">
            <div class="page-title-big">VÄƒn HÃ³a Cá»“ng ChiÃªng NgÆ°á»i ÃŠ ÄÃª</div>
            <div class="page-title-sub">Di sáº£n vÄƒn hÃ³a phi váº­t thá»ƒ Ä‘áº¡i diá»‡n cá»§a nhÃ¢n loáº¡i</div>
          </div>
        </div>

        <div class="topbar-right">
          <div class="search-pill">
            <span class="search-ico">ğŸ”</span>
            <!-- giá»¯ ID searchInput Ä‘á»ƒ JS cÅ© váº«n cháº¡y -->
            <input id="searchInput" type="text" placeholder="TÃ¬m theo tÃªn / nguá»“n gá»‘c..." />
            <button class="primary-btn" id="openPostModal" type="button">â• ÄÄƒng bÃ i</button>
          </div>

          <select id="filterSound" class="select-pill">
            <option value="">Táº¥t cáº£ Ã¢m thanh</option>
            <option value="Tráº§m">Tráº§m</option>
            <option value="Trung">Trung</option>
            <option value="Cao">Cao</option>
          </select>

          <button class="primary-btn" onclick="loadData()">Táº£i láº¡i</button>
          <button class="ghost-btn" onclick="exportData()">Táº£i JSON</button>
        </div>
      </header>

      <!-- GRID LAYOUT: feed + right panel -->
      <div class="content">
        <!-- FEED -->
        <section class="feed">

          <!-- HOME (giá»¯ id) -->
          <section id="home" class="card hero-card">
            <div class="hero-left">
              <div class="chip">âœ¨ KhÃ´ng gian vÄƒn hÃ³a TÃ¢y NguyÃªn</div>
              <h1>KhÃ´ng gian vÄƒn hÃ³a cá»“ng chiÃªng â€” â€œfeedâ€ trÆ°ng bÃ y sá»‘</h1>
              <p>
                Cá»“ng chiÃªng gáº¯n vá»›i lá»… há»™i, tÃ¢m linh vÃ  cá»™ng Ä‘á»“ng. Trang nÃ y hoáº¡t Ä‘á»™ng nhÆ° má»™t máº¡ng xÃ£ há»™i mini:
                báº¡n cÃ³ thá»ƒ tÃ¬m kiáº¿m, lá»c, thÃªm má»›i, xem thá»‘ng kÃª theo â€œÃ¢m thanhâ€.
              </p>
              <div class="hero-actions">
                <a class="primary-btn" href="#collection">Xem bá»™ sÆ°u táº­p</a>
                <a class="ghost-btn" href="#add">ThÃªm cá»“ng chiÃªng</a>
              </div>
            </div>

            <div class="hero-right">
              <div class="hero-metric">
                <div class="hero-metric-num" id="totalGongs">0</div>
                <div class="hero-metric-label">Tá»•ng sá»‘ cá»“ng chiÃªng</div>
              </div>
              <div class="hero-metric">
                <div class="hero-metric-num" id="avgAge">0</div>
                <div class="hero-metric-label">NiÃªn Ä‘áº¡i trung bÃ¬nh</div>
              </div>
              <div class="hero-blob"></div>
            </div>
          </section>

          <!-- ABOUT (giá»¯ id) -->
          <section id="about" class="card">
            <div class="card-head">
              <h2>Giá»›i thiá»‡u</h2>
              <div class="muted">Báº£n tÃ³m táº¯t nhanh theo kiá»ƒu â€œprofile cardâ€</div>
            </div>

            <div class="about-grid">
              <div class="mini-card">
                <div class="mini-ico">ğŸ§­</div>
                <div class="mini-title">Ã nghÄ©a</div>
                <div class="mini-text">Gáº¯n vá»›i lá»… há»™i, tÃ­n ngÆ°á»¡ng, vÃ²ng Ä‘á»i cá»™ng Ä‘á»“ng ngÆ°á»i ÃŠ ÄÃª.</div>
              </div>
              <div class="mini-card">
                <div class="mini-ico">ğŸ› ï¸</div>
                <div class="mini-title">Cáº¥u táº¡o</div>
                <div class="mini-text">Há»£p kim Ä‘á»“ng, má»—i chiáº¿c cÃ³ cao Ä‘á»™/Ã¢m sáº¯c riÃªng.</div>
              </div>
              <div class="mini-card">
                <div class="mini-ico">ğŸ¶</div>
                <div class="mini-title">Nghá»‡ thuáº­t</div>
                <div class="mini-text">HÃ²a quyá»‡n con ngÆ°á»i â€“ thiÃªn nhiÃªn trong khÃ´ng gian lá»… há»™i.</div>
              </div>
            </div>
          </section>

          <!-- COLLECTION (giá»¯ id) -->
          <section id="collection" class="card">
            <div class="card-head">
              <h2>Bá»™ sÆ°u táº­p</h2>
              <div class="muted">Dáº¡ng â€œfeed cardsâ€ â€” cÃ³ tÃ¬m kiáº¿m & lá»c</div>
            </div>

            <!-- giá»¯ id gongList Ä‘á»ƒ JS render -->
            <div id="gongList" class="gong-feed">
              <div class="loading">Äang táº£i dá»¯ liá»‡u...</div>
            </div>
          </section>

          <!-- ADD (giá»¯ id) -->
          <section id="add" class="card">
            <div class="card-head">
              <h2>ÄÄƒng bÃ i má»›i</h2>
              <div class="muted">Form theo kiá»ƒu máº¡ng xÃ£ há»™i â€” gá»n, rÃµ, dá»… nháº­p</div>
            </div>

            <!-- giá»¯ id addGongForm Ä‘á»ƒ JS submit -->
            <form id="addGongForm" class="post-form">
              <div class="form-row">
                <div class="field">
                  <label>TÃªn cá»“ng chiÃªng</label>
                  <input type="text" id="name" placeholder="VD: Cá»“ng Máº¹" required />
                </div>
                <div class="field">
                  <label>Nguá»“n gá»‘c</label>
                  <input type="text" id="origin" placeholder="VD: BuÃ´n Ma Thuá»™t, Äáº¯k Láº¯k" required />
                </div>
              </div>

              <div class="form-row">
                <div class="field">
                  <label>NiÃªn Ä‘áº¡i (nÄƒm)</label>
                  <input type="number" id="age" placeholder="VD: 120" required />
                </div>
                <div class="field">
                  <label>Ã‚m thanh</label>
                  <select id="sound" required>
                    <option value="">-- Chá»n --</option>
                    <option value="Tráº§m">Tráº§m</option>
                    <option value="Trung">Trung</option>
                    <option value="Cao">Cao</option>
                  </select>
                </div>
              </div>

              <div class="field">
                <label>MÃ´ táº£</label>
                <textarea id="description" rows="4" placeholder="Viáº¿t vÃ i dÃ²ng mÃ´ táº£..." required></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="primary-btn">ÄÄƒng lÃªn bá»™ sÆ°u táº­p</button>
                <a class="ghost-btn" href="#collection">Xem ngay</a>
              </div>
            </form>
          </section>

        </section>

        <!-- RIGHT PANEL -->
        <aside class="panel">
          <section id="stats" class="card panel-card">
            <div class="card-head">
              <h2>Thá»‘ng kÃª</h2>
              <div class="muted">Realtime tá»« API</div>
            </div>

            <!-- giá»¯ id statsContainer/chartContainer Ä‘á»ƒ JS cÅ© -->
            <div id="statsContainer" class="stats-stack">
              <div class="stat-tile">
                <div class="stat-label">Tá»•ng sá»‘</div>
                <div class="stat-value" id="totalGongsSide">0</div>
              </div>
              <div class="stat-tile">
                <div class="stat-label">NiÃªn Ä‘áº¡i TB</div>
                <div class="stat-value" id="avgAgeSide">0</div>
              </div>
            </div>

            <div id="chartContainer" class="chart-box"></div>
          </section>

          <section class="card panel-card">
            <div class="card-head">
              <h2>Gá»£i Ã½</h2>
              <div class="muted">Nhá»¯ng máº¹o nhá» Ä‘á»ƒ dÃ¹ng nhanh</div>
            </div>
            <ul class="tips">
              <li>GÃµ tÃ¬m kiáº¿m á»Ÿ thanh trÃªn Ä‘á»ƒ lá»c tá»©c thÃ¬.</li>
              <li>Chá»n â€œÃ‚m thanhâ€ Ä‘á»ƒ xem phÃ¢n nhÃ³m Tráº§m/Trung/Cao.</li>
              <li>DÃ¹ng â€œTáº£i JSONâ€ Ä‘á»ƒ xuáº¥t dá»¯ liá»‡u.</li>
            </ul>
          </section>
        </aside>
      </div>
    </main>
  </div>

  <script>
    const API_URL = 'http://127.0.0.1:5000/api';
    let allGongs = [];

    // Sidebar mobile toggle
    const menuBtn = document.getElementById('menuBtn');
    menuBtn?.addEventListener('click', () => document.body.classList.toggle('sidebar-open'));

    // Kiá»ƒm tra káº¿t ná»‘i server
    async function checkServerStatus() {
      try {
        const response = await fetch(API_URL.replace('/api', '/'));
        if (response.ok) {
          const s = document.getElementById('serverStatus');
          const dot = document.getElementById('serverDot');
          s.textContent = 'âœ… Äang hoáº¡t Ä‘á»™ng';
          s.style.color = 'inherit';
          if (dot) dot.classList.add('on');
        }
      } catch (error) {
        const s = document.getElementById('serverStatus');
        const dot = document.getElementById('serverDot');
        s.textContent = 'âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c';
        s.style.color = 'inherit';
        if (dot) dot.classList.remove('on');
      }
    }

    // Táº£i dá»¯ liá»‡u tá»« server
    async function loadData() {
      try {
        const response = await fetch(`${API_URL}/gongs`);
        const data = await response.json();
        allGongs = data.gongs || data;
        displayGongs(allGongs);
        loadStats();
      } catch (error) {
        document.getElementById('gongList').innerHTML =
          '<div class="error">âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server. Vui lÃ²ng cháº¡y: <b>python app.py</b></div>';
        console.error('Error:', error);
      }
    }

    // Hiá»ƒn thá»‹ danh sÃ¡ch cá»“ng chiÃªng (feed style + an toÃ n dá»¯ liá»‡u thiáº¿u field)
    function displayGongs(gongs) {
      const container = document.getElementById('gongList');
      if (!Array.isArray(gongs) || gongs.length === 0) {
        container.innerHTML = '<div class="empty">ChÆ°a cÃ³ dá»¯ liá»‡u. HÃ£y â€œÄÄƒng bÃ i má»›iâ€ á»Ÿ má»¥c ThÃªm má»›i!</div>';
        return;
      }

      container.innerHTML = gongs.map(gong => {
        const id = gong?._id || '';
        const name = gong?.name ?? '(KhÃ´ng cÃ³ tÃªn)';
        const origin = gong?.origin ?? '(KhÃ´ng rÃµ nguá»“n gá»‘c)';
        const age = gong?.age ?? 'N/A';
        const sound = gong?.sound ?? 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
        const desc = gong?.description ?? '';

        const badgeClass = (sound || '').toLowerCase();

        return `
          <article class="post">
            <div class="post-head">
              <div class="avatar">ğŸ¥</div>
              <div class="post-meta">
                <div class="post-title">${name}</div>
                <div class="post-sub">${origin} â€¢ <span class="pill pill-${badgeClass}">${sound}</span></div>
              </div>
              <div class="post-age">${age} nÄƒm</div>
            </div>

            <div class="post-body">${desc}</div>

            <div class="post-actions">
              <button class="action-btn" onclick="deleteGong('${id}')">ğŸ—‘ï¸ XÃ³a</button>
            </div>
          </article>
        `;
      }).join('');
    }

    // ThÃªm cá»“ng chiÃªng má»›i
    document.getElementById('addGongForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const gongData = {
        name: document.getElementById('name').value,
        origin: document.getElementById('origin').value,
        age: parseInt(document.getElementById('age').value),
        description: document.getElementById('description').value,
        sound: document.getElementById('sound').value
      };

      try {
        const response = await fetch(`${API_URL}/gongs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(gongData)
        });

        if (response.ok) {
          alert('âœ… ÄÃ£ thÃªm cá»“ng chiÃªng thÃ nh cÃ´ng!');
          document.getElementById('addGongForm').reset();
          loadData();
          document.getElementById('collection').scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('âŒ CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i!');
        }
      } catch (error) {
        alert('âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server!');
        console.error('Error:', error);
      }
    });

    // XÃ³a cá»“ng chiÃªng
    async function deleteGong(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a cá»“ng chiÃªng nÃ y?')) return;

      try {
        const response = await fetch(`${API_URL}/gongs/${id}`, { method: 'DELETE' });
        if (response.ok) {
          loadData();
        } else {
          alert('âŒ CÃ³ lá»—i xáº£y ra khi xÃ³a!');
        }
      } catch (error) {
        alert('âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server!');
        console.error('Error:', error);
      }
    }

    // TÃ¬m kiáº¿m vÃ  lá»c (an toÃ n undefined)
    document.getElementById('searchInput').addEventListener('input', filterGongs);
    document.getElementById('filterSound').addEventListener('change', filterGongs);

    function filterGongs() {
      const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
      const soundFilter = document.getElementById('filterSound').value;

      const filtered = allGongs.filter(gong => {
        const name = (gong?.name || '').toLowerCase();
        const origin = (gong?.origin || '').toLowerCase();
        const sound = gong?.sound || '';

        const matchSearch = name.includes(searchTerm) || origin.includes(searchTerm);
        const matchSound = !soundFilter || sound === soundFilter;
        return matchSearch && matchSound;
      });

      displayGongs(filtered);
    }

    // Táº£i xuá»‘ng dá»¯ liá»‡u
    async function exportData() {
      try {
        const response = await fetch(`${API_URL}/export`);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cong_chieng_ede.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (error) {
        alert('âŒ KhÃ´ng thá»ƒ táº£i xuá»‘ng dá»¯ liá»‡u!');
        console.error('Error:', error);
      }
    }

    // Táº£i thá»‘ng kÃª
    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/stats`);
        const data = await response.json();

        if (data.success) {
          // hero
          document.getElementById('totalGongs').textContent = data.stats.total_gongs;
          document.getElementById('avgAge').textContent =
            data.stats.avg_age ? Math.round(data.stats.avg_age) : 'N/A';

          // side tiles
          document.getElementById('totalGongsSide').textContent = data.stats.total_gongs;
          document.getElementById('avgAgeSide').textContent =
            data.stats.avg_age ? Math.round(data.stats.avg_age) + ' nÄƒm' : 'N/A';

          displayChart(data.stats.by_sound);
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Biá»ƒu Ä‘á»“ Ä‘Æ¡n giáº£n (giá»¯ nguyÃªn logic cÅ©)
    function displayChart(soundStats) {
      const container = document.getElementById('chartContainer');
      if (!soundStats || soundStats.length === 0) {
        container.innerHTML = '<div class="muted">ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª</div>';
        return;
      }

      const max = Math.max(...soundStats.map(s => s.count));
      container.innerHTML =
        '<div class="chart-title">PhÃ¢n bá»‘ theo Ã¢m thanh</div>' +
        soundStats.map(item => `
          <div class="chart-row">
            <div class="chart-name">${item._id || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}</div>
            <div class="chart-bar">
              <div class="chart-fill" style="width:${(item.count / max) * 100}%"></div>
            </div>
            <div class="chart-num">${item.count}</div>
          </div>
        `).join('');
    }

    // Khá»Ÿi Ä‘á»™ng
    window.addEventListener('load', () => {
      checkServerStatus();
      loadData();
    });
  </script>
</body>
</html>
